# Plan: Fetch Issue Labels for Comment Webhooks

## Problem

In `src/Webhook/Parser/JiraRequestParser.php` (line 75-78), the webhook label filter assumes labels exist in the payload:

```php
$issueLabels = $payload->all()['issue']['fields']['labels'] ?? [];
if ($this->webhookLabelFilter->hasMatchingLabel($issueLabels) === false) {
    throw new RejectWebhookException(Response::HTTP_OK, 'Issue does not have any matching labels.');
}
```

- **Issue webhooks** (`jira:issue_created`, `jira:issue_updated`, `jira:issue_deleted`): payload contains `['issue']['fields']['labels']`
- **Comment webhooks** (`comment_created`, `comment_updated`): payload does NOT contain labels, so `$issueLabels = []`, causing all comment webhooks to be rejected

## Solution

When labels are not present in the payload, fetch the full issue from Jira API to retrieve the labels.

## Implementation Steps

### 1. Update `JiraRequestParser::doParse()` in `src/Webhook/Parser/JiraRequestParser.php`

Replace the current label extraction (lines 75-78) with:

```php
$issueLabels = $this->getIssueLabels($payload->all());
if ($this->webhookLabelFilter->hasMatchingLabel($issueLabels) === false) {
    throw new RejectWebhookException(Response::HTTP_OK, 'Issue does not have any matching labels.');
}
```

### 2. Add private method `getIssueLabels()` to `JiraRequestParser`

```php
/**
 * @return array<string>
 */
private function getIssueLabels(array $payload): array
{
    // Labels exist in payload (issue webhooks)
    if (isset($payload['issue']['fields']['labels'])) {
        return $payload['issue']['fields']['labels'];
    }

    // Labels not in payload (comment webhooks) - fetch from Jira API
    $issueKey = $payload['issue']['key'] ?? null;
    if ($issueKey === null) {
        return [];
    }

    try {
        $issue = $this->issueRepository->getFull($issueKey, checkLabel: false);
        return $issue->fields->labels ?? [];
    } catch (\Exception $e) {
        $this->logger?->warning('Failed to fetch issue labels from Jira API', [
            'issue_key' => $issueKey,
            'error' => $e->getMessage(),
        ]);
        return [];
    }
}
```

### 3. Update tests in `tests/Unit/Webhook/Parser/JiraRequestParserTest.php`

- Add test case for comment webhook with labels fetched from API
- Mock `IssueRepository::getFull()` to return an issue with labels
- Test error handling when API call fails

## Files to Modify

1. `src/Webhook/Parser/JiraRequestParser.php` - Add `getIssueLabels()` method
2. `tests/Unit/Webhook/Parser/JiraRequestParserTest.php` - Add test cases for comment webhooks

## Notes

- `IssueRepository` is already injected in `JiraRequestParser` (line 37) but not used
- `getFull()` has a `checkLabel` parameter that can be set to `false` to skip the user label check (line 31-42 of `IssueRepository.php`)
- Error handling returns empty array, which will cause the webhook to be rejected with "Issue does not have any matching labels" - this is acceptable behavior
