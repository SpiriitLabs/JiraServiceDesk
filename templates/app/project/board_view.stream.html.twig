<twig:Turbo:Stream:Replace
    target="#project_board_view"
>
    <div id="project_board_view">
    {% trans_default_domain 'app' %}
    {% set columnsNames = [] %}
    {% for columnName , columnValues in kanbanIssues %}
        {% set columnsNames = columnsNames|merge([columnName|lower|u.ascii|u.replace(' ', '-')]) %}
    {% endfor %}
    {% set query_parameters = app.request.query.all %}

    {% set base_query = app.request.query.all %}
    {% set route_params = app.request.attributes.get('_route_params') %}
    <div class="col-12 mb-2 d-flex align-items-center gap-2">
        <div class="assignee-list">
            {% for assignee in assignees %}
                {% set assign_param = assigneeId == assignee.accountId ? '' : assignee.accountId %}
                {% set query_parameters = query_parameters|merge({assignee: assign_param})|merge(app.request.attributes.get('_route_params')) %}
                <a href="{{ path('app_project_board_view_stream', query_parameters) }}" data-action="click->turbo-stream-link#navigate">
                    <span class="assigne-item{{ assigneeId == assignee.accountId ? ' selected' : '' }}">
                        {% if assignee.avatarUrls is not null  %}
                            <img title="{{ assignee.displayName }}" src="{{ assignee.avatarUrls['24x24'] }}" alt="user-img" class="avatar-xs rounded-circle me-1">
                        {% else %}
                            <svg class="icon avatar-xs rounded-circle me-1">
                                <use xlink:href="{{ asset('assets/images/icons/user.svg', 'app') }}"></use>
                            </svg>
                    </span>
                        {% endif %}
                </a>
            {% endfor %}
        </div>

        <div class="dropdown d-inline-block">
            <button class="btn btn-sm btn{% if selectedPriorities is empty %}-outline{% endif %}-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                <i class="mdi mdi-flag-outline"></i>
                {{ 'project.kanban.filter.priority.label'|trans }}
                {% if selectedPriorities is not empty %}
                    <span class="badge text-bg-primary rounded-pill">{{ selectedPriorities|length }}</span>
                {% endif %}
            </button>
            <div class="dropdown-menu">
                {% for priority in priorities %}
                    {% set jiraId = priority.jiraId ~ '' %}
                    {% set isSelected = jiraId in selectedPriorities %}
                    {% if isSelected %}
                        {% set newPriorities = selectedPriorities|filter(p => p != jiraId) %}
                    {% else %}
                        {% set newPriorities = selectedPriorities|merge([jiraId]) %}
                    {% endif %}
                    {% set toggleParams = base_query|merge({priority: newPriorities})|merge(route_params) %}
                    <a href="{{ path('app_project_board_view_stream', toggleParams) }}" class="dropdown-item" data-action="click->turbo-stream-link#navigate">
                        <i class="mdi {{ isSelected ? 'mdi-checkbox-marked' : 'mdi-checkbox-blank-outline' }} me-1"></i>
                        <img src="{{ priority.iconUrl }}" width="16" height="16" alt="">
                        {{ priority.name }}
                    </a>
                {% endfor %}
                {% if selectedPriorities is not empty %}
                    <div class="dropdown-divider"></div>
                    {% set resetParams = base_query|filter((v, k) => k != 'priority')|merge(route_params) %}
                    <a href="{{ path('app_project_board_view_stream', resetParams) }}" class="dropdown-item text-muted" data-action="click->turbo-stream-link#navigate">
                        <i class="mdi mdi-close me-1"></i> {{ 'project.kanban.filter.reset'|trans }}
                    </a>
                {% endif %}
            </div>
        </div>

        {% if currentSort == '' %}
            {% set nextSort = 'priority' %}
        {% elseif currentSort == 'priority' %}
            {% set nextSort = '-priority' %}
        {% else %}
            {% set nextSort = '' %}
        {% endif %}

        {% if nextSort != '' %}
            {% set sortParams = base_query|merge({_sort: nextSort})|merge(route_params) %}
        {% else %}
            {% set sortParams = base_query|filter((v, k) => k != '_sort')|merge(route_params) %}
        {% endif %}
        <a href="{{ path('app_project_board_view_stream', sortParams) }}" class="btn btn-sm btn-{% if currentSort == '' %}outline-{% endif %}secondary" data-action="click->turbo-stream-link#navigate">
            {% if currentSort == 'priority' %}
                <i class="mdi mdi-arrow-up"></i>
            {% elseif currentSort == '-priority' %}
                <i class="mdi mdi-arrow-down"></i>
            {% else %}
                <i class="mdi mdi-sort"></i>
            {% endif %}

            {{ 'project.kanban.sort.priority.label'|trans }}
        </a>
    </div>

    <div {{ stimulus_controller('scrollbar_top') }}>
        <div class="scrollbar-top" {{ stimulus_target('scrollbar_top', 'scrollbarTop') }}>
            <div class="scroll-inner" {{ stimulus_target('scrollbar_top', 'scrollbarTopInner') }}></div>
        </div>

        <div class="board" {{ stimulus_target('scrollbar_top', 'scrollbarBottom') }}>
            {% for columnName , columnValues in kanbanIssues %}
                <div class="tasks" {% if loop.first and is_granted('ROLE_APP_KANBAN') %}{{ stimulus_controller('kanban', {columns: columnsNames|json_encode, selectInputTitle: 'project.kanban.selectTransition.title'|trans}) }}{% endif %}>
                    <h5 class="mt-0 task-header text-uppercase">{{ columnName }} (<span class="fst-italic">{{ columnValues.issues|length }}</span>)</h5>

                    <div id="{{ columnName|lower|u.ascii|u.replace(' ', '-') }}" data-kanban-transition-ids='{{ columnValues.transitionIds|json_encode|e('html_attr') }}' class="task-list-items">

                        {% for issue in columnValues.issues %}
                            <twig:app:kanban:item_card
                                :issue="issue"
                                :project="current_project"
                            />
                        {% endfor %}

                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    </div>
</twig:Turbo:Stream:Replace>
